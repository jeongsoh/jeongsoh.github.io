{"paragraphs":[{"user":"admin","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604974962943_-1619402020","id":"20201110-112242_1920410730","dateCreated":"2020-11-10T11:22:42+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1049"},{"user":"admin","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604974972374_135402277","id":"20201110-112252_1034411011","dateCreated":"2020-11-10T11:22:52+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1202","text":"%pyspark\n\"\"\"\n    interpolated lp 데이터 활용, spark.read.format(\"orc\").load(\"C:/Users/user/cs_lp_filled_idnsa2\")\n    228개 미터에 대해 20191203 ~ 20200803 내 LP_FAP 수에 약간 차이가 존재\n    LP 데이터가 존재하는 공통 구간은 20191205 ~ 20200803\n\"\"\"\nfrom pyspark.sql import functions as Fn\nfrom pyspark.sql.functions import col\n\nlpdataD = spark.read.format(\"orc\").load(\"C:/Users/user/cs_lp_filled_idnsa2\")\n#lpdataD = spark.read.orc(\"hdfs://nameserver/apps/spark/warehouse/cs_lp_filled_idnsa2\")\n\nprint(\"For each meter, LP_RECV_YMD Min ~ LP_RECV_YMD Max\")\nlpdataD.groupBy(\"LP_METER_ID\").agg(Fn.min(lpdataD.LP_RECV_YMD), Fn.max(lpdataD.LP_RECV_YMD)).show(250)","dateUpdated":"2020-11-10T11:39:07+0900","title":"A.1 시간별 사용량 데이터셋  - 시간별 사용량 데이터 생성을 위한 누적 cs_lp_filled_idnsa2 데이터 적재  "},{"text":"%pyspark\n\"\"\"\n    20191203 ~ 20200803\n    일별 96개 구간 데이터 활용 시 공통 구간은 20191205 ~ 20200803\n\"\"\"\nprint(\"일별 96 개 구간 데이터가 공통적으로 존재하는 구간\")\nlpdataD.groupBy(\"LP_METER_ID\").agg(Fn.min(lpdataD.LP_RECV_YMD).alias(\"min\"), Fn.max(lpdataD.LP_RECV_YMD).alias(\"max\")).\\\n    withColumn(\"LP_RECV_YMD_MIN\", col(\"min\")).withColumn(\"LP_RECV_YMD_MAX\", col(\"max\")).select(Fn.max(\"LP_RECV_YMD_MIN\"),\\\n    Fn.min(\"LP_RECV_YMD_MAX\")).show()","user":"admin","dateUpdated":"2020-11-10T11:24:55+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975037307_631914193","id":"20201110-112357_1113335735","dateCreated":"2020-11-10T11:23:57+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1290","title":"일별 구간 데이터 생성 전 공통 구간 (일별 96개 구간)"},{"text":"%pyspark\n%pyspark\n\"\"\"\n    1시간 간격 사용량 데이터 생성\n\"\"\"\nhour_list = [\"0000\", \"0100\", \"0200\", \"0300\", \"0400\", \"0500\", \"0600\", \"0700\", \"0800\", \"0900\", \"1000\", \"1100\", \"1200\", \"1300\", \"1400\", \"1500\", \"1600\", \"1700\", \"1800\", \"1900\", \"2000\", \"2100\", \"2200\", \"2300\"]\nlpdataH = lpdataD.where(col(\"LP_RECV_HM\").isin(hour_list)==True).\\\n        select(\"LP_METER_ID\", \"LP_DCU_ID\", \"LP_METER_TIME\", \"LP_RECV_YMD\", \"LP_RECV_HM\", \"LP_FAP\")\nlpdataH.show(20)","user":"admin","dateUpdated":"2020-11-10T11:25:39+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975109276_771615349","id":"20201110-112509_761421279","dateCreated":"2020-11-10T11:25:09+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1380"},{"text":"%pyspark\nlpdataH.printSchema()","user":"admin","dateUpdated":"2020-11-10T11:26:07+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975149724_1452391032","id":"20201110-112549_922363986","dateCreated":"2020-11-10T11:25:49+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1452"},{"text":"%pyspark\n\"\"\"\n   LP_METER_TIME 타입을 string -> timestamp -> int 형으로 전환하여 window 생성에 활용\n\"\"\"\nlpdataH = lpdataH.withColumn(\"LP_METER_TIME\", Fn.to_timestamp(\"LP_METER_TIME\", \"yyyy-MM-dd HH:mm:ss\"))\nlpdataH = lpdataH.withColumn(\"meter_time\", col(\"LP_METER_TIME\")).withColumn(\"LP_METER_TIME\", col(\"LP_METER_TIME\").cast(\"integer\"))\nlpdataH.show(5, False)","user":"admin","dateUpdated":"2020-11-10T11:27:07+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975167203_1953092543","id":"20201110-112607_1510899095","dateCreated":"2020-11-10T11:26:07+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1524"},{"text":"%pyspark\n\"\"\"\n    1시간 간격별 구간 사용량\n\"\"\"\nfrom pyspark.sql.window import Window\n\nhourly_window = Window.partitionBy(lpdataH.LP_METER_ID).orderBy(lpdataH.LP_METER_TIME)\nlpdataH = lpdataH.withColumn(\"next\",Fn.lead(lpdataH.LP_FAP).over(hourly_window))\nlpdataH = lpdataH.withColumn(\"hourly_usage\",Fn.when(Fn.isnull(lpdataH.next - lpdataH.LP_FAP),\"no_next\").otherwise(lpdataH.next-lpdataH.LP_FAP))\nlpdataH = lpdataH.withColumn(\"hourly_usage\",Fn.when(Fn.isnull(lpdataH.next - lpdataH.LP_FAP),\"no_next\").when((lpdataH.next-lpdataH.LP_FAP) < 0, Fn.lit(\"neg\")).otherwise(lpdataH.next-lpdataH.LP_FAP))\nlpdataH.show(5)","user":"admin","dateUpdated":"2020-11-10T11:27:31+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975237756_-1548019620","id":"20201110-112717_770438891","dateCreated":"2020-11-10T11:27:17+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1596"},{"text":"%pyspark\n\"\"\"\n   일별 전력사용량이 0인 미터를 제외\n\"\"\"\nprint(\"총 1시간 구간별 사용량 데이터 수: \" + str(lpdataH.count()))\nprint(\"228 개 미터의 최종 일자 사용량은 null을 나타내는 # of no_next: \" + str(lpdataH.where(col(\"hourly_usage\") == \"no_next\").count()))\nprint(\"총 데이터 - Null 데이터: \" + str(lpdataH.filter(col(\"next\").isNotNull()).count()))\nprint(\"전력사용량이 0 인 데이터 수: \" + str(lpdataH.where(lpdataD.LP_FAP == lpdataH.next).count()))\nprint(\"hourly_usage < 0 인 데이터 수: \" + str(lpdataH.where(\"hourly_usage =='neg'\").count()))\nlpdataH.where(\"hourly_usage =='no_next'\").show(10)","user":"admin","dateUpdated":"2020-11-10T11:28:12+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975261756_1059824804","id":"20201110-112741_638608307","dateCreated":"2020-11-10T11:27:41+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1668"},{"text":"%pyspark\n\"\"\"\n    전력 미사용 미터 목록\n\"\"\"\nmeter_id_no_usage = spark.read.orc(\"C:/Users/user/meter_id_no_usage\")\nmeter_id_no_usageList = [ row[\"LP_METER_ID\"] for row in meter_id_no_usage.collect()]\nprint(\"전력 미사용 미터 개수\" + str(len(meter_id_no_usageList)))\n\nmeter_id_no_usageList","user":"admin","dateUpdated":"2020-11-10T11:28:48+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975295115_325326317","id":"20201110-112815_91903211","dateCreated":"2020-11-10T11:28:15+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1740"},{"text":"%pyspark\n\"\"\"\n    비교\n\"\"\"\nmeter_id_no_usageList_copy = ['99260000217', '99260000302', '99260000491', '99260000223', '99260000391', '99260000220', '99260000067', '99260000462', '99260000464', '99260000212', '99260000171', '99260000196', '99260000330', '99260000280', '99260000315', '99260000232', '99260000154', '99260000013', '99260000337', '99260000473', '99260000335', '99260000423', '99260000047', '99260000137', '99260000178', '99260000435', '99260000150', '99260000208', '99260000463', '99260000475', '99260000528', '99260000116', '99260000338', '99260000443', '99260000328', '99260000092', '99260000216', '99260000102', '99260000515', '99260000241', '99260000439', '99260000426', '99260000495', '99260000041', '99260000132', '99260000098', '99260000005', '99260000285', '99260000243', '99260000274', '99260000323', '99260000472', '99260000306', '99260000326', '99260000487', '99260000341', '99260000433', '99260000101', '99260000221', '99260000174', '99260000238', '99260000198', '99260000492', '99260000164', '99260000496', '99260000103', '99260000470', '99260000135', '99260000248', '99260000209', '99260000161', '99260000307', '99260000371', '99260000474', '99260000148', '99260000506', '99260000507', '99260000290', '99260000351', '99260000080', '99260000236', '99260000170', '99260000058', '99260000399', '99260000049', '99260000138', '99260000291', '99260000247', '99260000277', '99260000033', '99260000425', '99260000139', '99260000181']\nmeter_id_no_usageList_copy.sort() == meter_id_no_usageList.sort()","user":"admin","dateUpdated":"2020-11-10T11:29:22+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975297836_-207277395","id":"20201110-112817_1507328914","dateCreated":"2020-11-10T11:28:17+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1812"},{"text":"%pyspark\n\"\"\"\n    불필요한 컬럼 제외\n\"\"\"\nlpdataH = lpdataH.drop(\"LP_METER_TIME\", \"next\", \"LP_FAP\").withColumnRenamed(\"meter_time\", \"LP_METER_TIME\")\nlpdataH.show(5, False)","user":"admin","dateUpdated":"2020-11-10T11:29:59+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975383307_-901255682","id":"20201110-112943_425357099","dateCreated":"2020-11-10T11:29:43+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1884"},{"text":"%pyspark\n\"\"\"\n    228 개 미터 중 전력 미사용 미터 93 개를 제외한 135 개 미터\n    20191206 ~ 20200802 (241일간)\n\"\"\"\n\nlpdata1hr = lpdataH.where((col(\"LP_RECV_YMD\") > 20191205) & (col(\"LP_RECV_YMD\") < 20200803)).\\\n        where(col(\"LP_METER_ID\").isin(meter_id_no_usageList)==False).\\\n        select(\"LP_METER_ID\", \"LP_DCU_ID\", \"LP_METER_TIME\", \"LP_RECV_YMD\", \"LP_RECV_HM\", \"hourly_usage\")\nlpdata1hr.select(Fn.countDistinct(\"LP_METER_ID\"), Fn.countDistinct(\"LP_DCU_ID\"),Fn.countDistinct(\"LP_RECV_YMD\"), Fn.countDistinct(\"LP_RECV_HM\") ).show()\nlpdata1hr.printSchema()","user":"admin","dateUpdated":"2020-11-10T11:30:15+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975384723_817250940","id":"20201110-112944_974424982","dateCreated":"2020-11-10T11:29:44+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1956"},{"text":"%pyspark\nlpdata1hr.withColumn(\"LP_METER_TIME\", Fn.col(\"LP_METER_TIME\").cast(\"string\")).\\\n        select([Fn.count(Fn.when(Fn.isnan(c) | col(c).isNull(), c)).alias(c) for c in lpdata1hr.columns]).show()","user":"admin","dateUpdated":"2020-11-10T11:30:29+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975420404_-888220247","id":"20201110-113020_1267743896","dateCreated":"2020-11-10T11:30:20+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2028"},{"text":"%pyspark\n\"\"\"\n    1시간 간격별 데이터 저장\n\"\"\"\nlpdata1hr.write.orc(\"C:/Users/user/cs_lp_1hr_idnsa2\",\"overwrite\")\n#lpdata1hr.write.option(\"orc.compress\",\"snappy\").orc(\"/apps/spark/warehouse/cs_lp_1hr_idnsa2\",\"overwrite\")","user":"admin","dateUpdated":"2020-11-10T11:36:03+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975433156_566000506","id":"20201110-113033_1440816647","dateCreated":"2020-11-10T11:30:33+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2100"},{"text":"%pyspark\n\"\"\"\n    spark.sql.pivotMaxValues 10000에서 30000으로 변경, 135개 미터, 241일 x 24시간 = 5784로 변경하지 않아도 무방\n\"\"\"\nfrom pyspark.conf import SparkConf\nfrom pyspark.sql import SparkSession\nspark.conf.set(\"spark.sql.pivotMaxValues\", \"30000\")\nspark.conf.set(\"zeppelin.interpreter.output.limit\", \"1024000\")\nspark.sparkContext._conf.getAll()\n#spark.sparkContext._conf.get(\"spark.driver.memory\")","user":"admin","dateUpdated":"2020-11-10T11:33:25+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975490740_-1723158856","id":"20201110-113130_1299622891","dateCreated":"2020-11-10T11:31:30+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2172"},{"text":"%pyspark\n\"\"\"\n    135 개 미터에 대해 20191206 ~ 20200802 (241 일), DCU 5 개\n    cs_lp_1hr_idnsa2를 적재하여 미터별 일별 1시간 간격별 사용량 특징 데이터셋을 생성\n    .withColumn(\"month\", Fn.month(df.readtime))\n    일별 사용량 관련 Standard Deviation, Max 추가\n\n\"\"\"\nfrom pyspark.sql import functions as Fn\nfrom pyspark.sql.functions import col, lit\n\noneH = spark.read.format(\"orc\").load(\"C:/Users/user/cs_lp_1hr_idnsa2\")\n#oneH = spark.read.orc(\"hdfs://nameserver/apps/spark/warehouse/cs_lp_1hr_idnsa2\")\n\noneH = oneH.withColumn(\"daily_combination\", Fn.concat(Fn.lit(\"daily_\"),\"LP_RECV_YMD\", \"LP_RECV_HM\"))\noneH = oneH.withColumn(\"hourly_usage\", Fn.col(\"hourly_usage\").cast(\"float\"))\noneH.show(5)\noneH_features = oneH.groupBy(\"LP_METER_ID\",\"LP_DCU_ID\").pivot(\"daily_combination\").avg(\"hourly_usage\")\noneH_features.printSchema()","user":"admin","dateUpdated":"2020-11-10T11:35:44+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975576739_739378297","id":"20201110-113256_836970329","dateCreated":"2020-11-10T11:32:56+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2244"},{"text":"%pyspark\noneH_features.write.option(\"orc.compress\", \"snappy\").orc(\"C:/Users/user/cs_oneH_features\",\"overwrite\")\n#oneH_features.write.option(\"orc.compress\", \"snappy\").orc(\"/apps/spark/warehouse/cs_oneH_features\",\"overwrite\")","user":"admin","dateUpdated":"2020-11-10T11:36:56+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975609667_-106106789","id":"20201110-113329_1411549322","dateCreated":"2020-11-10T11:33:29+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2316"},{"text":"%pyspark\noneH_features.select([Fn.count(Fn.when(Fn.isnan(c) | col(c).isNull(), c)).alias(c) for c in oneH_features.columns]).show()","user":"admin","dateUpdated":"2020-11-10T11:37:10+0900","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1604975796475_1419957035","id":"20201110-113636_2001234343","dateCreated":"2020-11-10T11:36:36+0900","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2388"}],"name":"pyspark cs_lp_idnsa2 data hourly 202011","id":"2FRMRYGRR","noteParams":{},"noteForms":{},"angularObjects":{"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}